# Custom PostgreSQL image with Python data loading capabilities
FROM postgis/postgis:17-3.5

# Install Python and required system packages
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    gdal-bin \
    libgdal-dev \
    proj-bin \
    && rm -rf /var/lib/apt/lists/*

# Create virtual environment for Python packages
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip and install Python dependencies
RUN pip install --upgrade pip

# Install geospatial and data processing packages (compatible with Python 3.9)
RUN pip install \
    numpy==1.24.4 \
    pandas==1.5.3 \
    pyarrow==10.0.1 \
    geopandas==0.14.4 \
    psycopg2-binary==2.9.10 \
    sqlalchemy==2.0.43 \
    geoalchemy2==0.17.1 \
    requests==2.31.0

# Create directory for initialization scripts and data
RUN mkdir -p /docker-entrypoint-initdb.d/data

# Copy data files to container (these will be mounted at runtime)
# The actual data files will be mounted from host

# Copy the Python initialization script to a different location
COPY postgres/docker/init-data.py /usr/local/bin/init-taxi-data.py
RUN chmod +x /usr/local/bin/init-taxi-data.py

# Create a custom entrypoint that runs after PostgreSQL is started
RUN echo '#!/bin/bash' > /usr/local/bin/custom-entrypoint.sh && \
    echo 'set -e' >> /usr/local/bin/custom-entrypoint.sh && \
    echo '' >> /usr/local/bin/custom-entrypoint.sh && \
    echo '# Start PostgreSQL normally' >> /usr/local/bin/custom-entrypoint.sh && \
    echo '/usr/local/bin/docker-entrypoint.sh postgres &' >> /usr/local/bin/custom-entrypoint.sh && \
    echo 'POSTGRES_PID=$!' >> /usr/local/bin/custom-entrypoint.sh && \
    echo '' >> /usr/local/bin/custom-entrypoint.sh && \
    echo '# Wait for PostgreSQL to be ready and then run initialization' >> /usr/local/bin/custom-entrypoint.sh && \
    echo 'sleep 10' >> /usr/local/bin/custom-entrypoint.sh && \
    echo 'echo "ðŸ”„ Running NYC Taxi data initialization..."' >> /usr/local/bin/custom-entrypoint.sh && \
    echo 'python3 /usr/local/bin/init-taxi-data.py' >> /usr/local/bin/custom-entrypoint.sh && \
    echo '' >> /usr/local/bin/custom-entrypoint.sh && \
    echo '# Keep PostgreSQL running' >> /usr/local/bin/custom-entrypoint.sh && \
    echo 'wait $POSTGRES_PID' >> /usr/local/bin/custom-entrypoint.sh && \
    chmod +x /usr/local/bin/custom-entrypoint.sh

# Set environment variables for initialization
ENV INIT_LOAD_ALL_DATA=true
ENV PYTHONPATH=/opt/venv/lib/python3.11/site-packages

# Use custom entrypoint
ENTRYPOINT ["/usr/local/bin/custom-entrypoint.sh"]